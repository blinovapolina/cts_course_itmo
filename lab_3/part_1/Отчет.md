# Лабораторная работа №3 (Часть 1)

## Описание 1 части лабораторной работы

Данная лабораторная работа демонстрирует плохие практики безопасности в CI/CD пайплайнах GitHub Actions и их исправления. Работа включает в себя два набора файлов:

- **Bad practices** (`*-bad.yml`) - файлы с плохими практиками безопасности
- **Good practices** (`*.yml`) - исправленные файлы с правильными практиками

## Структура проекта

```tree
lab/
├── main-bad.yml      # Основной workflow с плохими практиками
├── main.yml          # Исправленный основной workflow
├── deploy-bad.yml    # Deploy workflow с плохими практиками
├── deploy.yml        # Исправленный deploy workflow
└── README.md         # Данный файл
```

## Анализ плохих практик и их исправлений

### 1. Основной workflow (main-bad.yml → main.yml)

#### Плохие практики в main-bad.yml

**1.1. Отсутствие фильтрации акторов**

```yaml
# Плохо: нет проверки на ботов и недоверенных акторов
auto-assign:
  name: Auto-assign
  runs-on: ubuntu-latest
  # Нет фильтрации - срабатывает для всех!
```

**1.2. Избыточные разрешения**

```yaml
# Плохо: слишком много разрешений для простых задач
permissions:
  issues: write
  checks: write
  actions: write
  contents: write
  pull-requests: write
```

**1.3. Отключение проверок при ошибках**

```yaml
# Плохо: ошибки линтера не останавливают пайплайн
- name: Ruff — static analysis
  run: |
    ruff --config pyproject.toml check .
  continue-on-error: true # Плохо: ошибки линтера не останавливают пайплайн
```

**1.4. Слишком высокий лимит ошибок в тестах**

```yaml
# Плохо: высокий maxfail может скрыть проблемы
pytest --maxfail=3 --disable-warnings -q
```

**1.5. Отключение важных уведомлений**

```yaml
# Плохо: отключены важные уведомления
send-summary-comment: false # Скрывает проблемы в PR
show-annotations: "off" # Отключает предупреждения
```

#### Исправления в main.yml:

**1.1. Добавлена фильтрация акторов**

```yaml
# Хорошо: проверка на ботов и недоверенных акторов
if: ${{ github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]' }}
```

**1.2. Минимальные необходимые разрешения**

```yaml
# Хорошо: только необходимые разрешения
permissions:
  actions: read
  contents: read
```

**1.3. Строгие проверки качества**

```yaml
# Хорошо: ошибки линтера останавливают пайплайн
- name: Ruff — static analysis
  run: |
    ruff --config pyproject.toml check .
  # Убран continue-on-error: true
```

**1.4. Строгий лимит ошибок**

```yaml
# Хорошо: строгий лимит для быстрого выявления проблем
pytest --maxfail=1 --disable-warnings -q
```

**1.5. Включены важные уведомления**

```yaml
# Хорошо: включены уведомления для прозрачности
send-summary-comment: true
show-annotations: "warning"
```

### 2. Deploy workflow (deploy-bad.yml → deploy.yml)

#### Плохие практики в deploy-bad.yml:

**2.1. Хардкод учетных данных**

```yaml
# Плохо: учетные данные в открытом виде
- name: Login to GitHub Container Registry
  uses: docker/login-action@v3
  with:
    registry: ghcr.io
    username: myusername
    password: mypassword123
```

**2.2. Отсутствие фильтрации для Docker build**

```yaml
# Плохо: нет ограничений на Docker build для ботов
docker-build:
  name: Build and push Docker image
  runs-on: ubuntu-latest
  # Нет проверки на ботов!
```

**2.3. Хардкод VPN конфигурации**

```yaml
# Плохо: VPN конфигурация в открытом виде
- name: Write OpenVPN config
  run: |
    cat > client.ovpn <<'OVPN'
    client
    dev tun
    proto udp
    remote vpn.example.com 1194
    # ... хардкод конфигурации
```

**2.4. Хардкод SSH ключей**

```yaml
# Плохо: SSH ключ в открытом виде
- name: Deploy over SSH
  uses: appleboy/ssh-action@v1.2.0
  with:
    host: 198.51.100.25
    username: root
    key: |
      -----BEGIN OPENSSH PRIVATE KEY-----
      badkeybadkeybadkeybadkeybadkeybadkeybadkey
      -----END OPENSSH PRIVATE KEY-----
```

**2.5. Небезопасные настройки SSH**

```yaml
# Плохо: небезопасные настройки
use_insecure_cipher: true
timeout: 120s
command_timeout: 120s
```

#### Исправления в deploy.yml

**2.1. Использование секретов**

```yaml
# Хорошо: использование GitHub секретов
- name: Login to GitHub Container Registry
  uses: docker/login-action@v3
  with:
    registry: ghcr.io
    username: ${{ github.actor }}
    password: ${{ secrets.GITHUB_TOKEN }}
```

**2.2. Фильтрация для Docker build**

```yaml
# Хорошо: проверка на ботов и skip инструкции
if: ${{ github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '[[skip docker build]]') }}
```

**2.3. Использование секретов для VPN**

```yaml
# Хорошо: VPN конфигурация из секретов
- name: Write OpenVPN config
  run: |
    cat > client.ovpn <<'OVPN'
    ${{ secrets.OPENVPN }}
    OVPN
```

**2.4. Использование секретов для SSH**

```yaml
# Хорошо: SSH данные из секретов
- name: Deploy over SSH
  uses: appleboy/ssh-action@v1.2.0
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USER }}
    key: ${{ secrets.SSH_KEY }}
```

**2.5. Безопасные настройки SSH**

```yaml
# Хорошо: безопасные настройки
use_insecure_cipher: false
timeout: 60s
command_timeout: 60s
```

## Настройка секретов

Для работы исправленных workflow необходимо настроить следующие секреты в GitHub:

### Для deploy.yml

- `OPENVPN` - конфигурация OpenVPN
- `OPENVPN_USER` - имя пользователя VPN
- `OPENVPN_PASS` - пароль VPN
- `SSH_HOST` - хост для SSH подключения
- `SSH_USER` - пользователь SSH
- `SSH_KEY` - приватный SSH ключ
- Для пользователя deploy на сервере в файле sudoers от root разрешен только запуск файла деплоя

### Для main.yml

- `BARECHECK_GITHUB_APP_TOKEN` - токен для Barecheck

## Заключение

Данная лабораторная работа демонстрирует важность соблюдения принципов безопасности при разработке CI/CD пайплайнов. Правильная реализация включает:

1. **Безопасное управление секретами** - использование GitHub Secrets
2. **Контроль доступа** - фильтрация акторов и минимальные разрешения
3. **Строгий контроль качества** - ошибки должны останавливать пайплайн
4. **Прозрачность** - включение уведомлений и отчетов
5. **Безопасность инфраструктуры** - использование безопасных настроек

Следование этим принципам помогает предотвратить утечки данных, несанкционированный доступ и другие проблемы безопасности в CI/CD процессах.
